#!/bin/bash

### BEGIN INIT INFO
# Provides:          <%= application %>
# Required-Start:    $all
# Required-Stop:     $network $local_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start the <%= application %> resque worker at boot
# Description:       Enable <%= application %> at boot time.
### END INIT INFO

set -e
set -u

APP_ROOT=<%= deploy_to %>/current
USER=<%= user %>

TIMEOUT=${TIMEOUT-60}
PIDFILE="$APP_ROOT/tmp/pids/resque.%d.pid"
QUEUES="*"
COUNT=1

run () {
  if [ "$(id -un)" = "$USER" ]; then
    eval $1
  else
    su -c "$1" - $USER
  fi
}

case "$1" in
  start)
    for i in $(seq 1 $COUNT); do
      pidfile=$(printf "$PIDFILE" $i)

      if test -s "$pidfile" && kill -0 `cat $pidfile`; then
        echo "Worker $i alread running"
      else
        run "cd $APP_ROOT; QUEUE=$QUEUES PIDFILE=$pidfile TERM_CHILD=1 BACKGROUND=yes ~/.rvm/bin/rvm default do bundle exec rake environment resque:work"
        echo "Start worker `cat $pidfile`"
      fi
    done
    ;;
  stop)
    for i in $(seq 1 $COUNT); do
      pidfile=$(printf "$PIDFILE" $i)

      if test -s "$pidfile" && run "kill -QUIT `cat $pidfile`"; then
        echo "Stop worker `cat $pidfile`"
        run "rm $pidfile"
      fi
    done
    ;;
  restart|reload)
    $0 stop
    sleep 1
    $0 start
    ;;
  *)
    echo >&2 "Usage: $0 <start|stop|restart|upgrade|force-stop|reopen-logs>"
    exit 1
    ;;
esac
